name: HP Pavilion 14-dv1xxx

on:
  push:
    paths:
      - '.github/workflows/hp-pavilion-14-dv1xxx.yml'
      - 'conf/hp-pavilion-14-dv1xxx'
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        repo: [~/work/my-kernel/my-kernel]
        kver: [6.9]
        conf: [hp-pavilion-14-dv1xxx]

    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt install -y --fix-broken --fix-missing \
           build-essential flex bison bc ncurses-dev texinfo gcc gperf patch libtool \
           automake g++ libncurses5-dev gawk subversion expat gettext libexpat1-dev \
           python-all-dev binutils-dev libcap-dev libmpfr-dev autopoint txt2man \
           liblzma-dev libssl-dev libz-dev curl tar gcc-10 g++-10 zstd \
           debhelper-compat

      - name: Checkout source
        uses: actions/checkout@v3
        with:
          repo: alemontn/my-kernel
          path: ${{ matrix.repo }}

      - name: Update kernel source
        run: |
          cd ${{ matrix.repo }}
          git submodule update --init linux
          cd linux
          git checkout v"$kver"

      - name: Setup kernel source
        run: |
          cd ${{ matrix.repo }}/linux
          make clean
          cp ${{ matrix.repo }}/conf/${{ matrix.conf }} .config

      - name: Build kernel
        run: |
          cd ${{ matrix.repo }}/linux
          make -j$(nproc --all)
          make bindeb-pkg

      - name: Package kernel
        run: |
          cd ${{ matrix.repo }}/linux
          find=$(find debian -maxdepth 1 | grep -F "debian/linux-")
          image=$(grep -F "debian/linux-image-" <<<"$find" | head -1)
          headers=$(grep -F "debian/linux-headers-" <<<"$find" | head -1)
          dpkg-deb --root-owner-group --build "$image"
          dpkg-deb --root-owner-group --build "$headers"
          mkdir ~/out
          mv *.deb ~/out

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel
          path: /home/runner/out
